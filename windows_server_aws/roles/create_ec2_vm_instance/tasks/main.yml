---  
  - name: Create {{ tag_environment }} EC2 instance name {{ item }}
    amazon.aws.ec2_instance:
      access_key: "{{ AWS_ACCESS_KEY_ID }}"
      secret_key: "{{ AWS_SECRET_KEY }}"
      instance_type: "{{ instance_type | default('t2.small') }}"
      region: "{{ region }}"
      image_id: "{{ image_id }}"
      key_name: "{{ key_name }}"
      count: "1"
      name: "{{ item }}" 
      vpc_subnet_id: "{{subnet_ids.subnet.id}}"
      security_group: "{{ securityGroup.group_name }}"
      network_interfaces:
        - assign_public_ip: true
      tags:
        Name: "{{ item }}"
        Type: "windowServer"
        Env: "{{ tag_environment }}"
        Project: "{{ project_name }}"
        Provider: "AWS"
      volumes:
        - device_name: /dev/sda1
          ebs:
            volume_size: 30
            volume_type: gp2
            delete_on_termination: true
      state: started
      wait: true
    register: ec2_instance

  - name: show {{ item }} public ip
    debug:
      msg: "{{ ec2_instance.instances[0].public_dns_name }}"

  - name: Get admin password
    community.aws.ec2_win_password:
      access_key: "{{ AWS_ACCESS_KEY_ID }}"
      secret_key: "{{ AWS_SECRET_KEY }}"
      instance_id: "{{ ec2_instance.instances[0].instance_id }}"
      region: "{{ region }}"
      key_file: "{{ key_file }}"
      wait: true
    register: password

  - name: show password {{ item }}
    debug:
      msg: "{{ password.win_password }}"
